# 会計年度の初期化

このドキュメントは、機能 *会計年度の初期化* の仕様を整理したものです。

## Overview

会計年度の初期化は以下の手順で行われます。入力として対象の年度を数値で受け取ります(`2025` 等)。

1. 会計年度から12ヶ月分の会計月度エンティティを生成します。
2. 生成したエンティティに対し勤務日数エンティティを生成します。
   勤務日数にはデフォルト値として `20` を渡していますが、本来はカレンダーに基づき自動設定されるべきです(TODO)。
3. 会計年度・勤務日数エンティティをINSERTします。
4. [報酬実績の自動計算](./automated_income_calculation.md)に基づき実績値を計算し、INSERTします。

## Limitation

3, 4は本来トランザクションを張って行われるべきものですが、Cloudflare D1にはトランザクションの機能がありません。
また、4を処理するには3が実際にレコードとして書き込まれていなければならないため、batch機能を使うこともできません。

本来はトランザクションを使用するべきです。(言い換えれば)これができないD1でこのような処理を実行するべきではありません。
しかし、現時点では **一旦この問題に目を瞑り** 、妥協案として `D1DatabaseSession` を採用します。
(実際妥協としても弱い線ですが、問題になるまではこの方針で進めます)
