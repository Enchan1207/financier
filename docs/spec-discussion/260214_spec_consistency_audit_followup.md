# 260214 仕様整合性監査（docs/spec）追補

## 対象

- `docs/spec/requirements.md`
- `docs/spec/functions.md`
- `docs/spec/usecases.md`

## 監査サマリ

- 重大な不整合: 0件
- 中程度の不整合: 0件
- 未定義/曖昧: 0件
- 解消済み: 5件

## 指摘一覧

### 1. 積立 `archived` の意味が自己矛盾している（解消済み）

**確認結果**:

- `SavingDefinition` から `status` 属性および状態遷移定義が削除された
- `docs/spec/usecases.md` から UC-4.5（積立のアーカイブ）が削除された
- `docs/spec/usecases.md` の積立関連記述は状態依存文言を持たない表現に統一された

**解消理由**:

- 積立に `archived` 状態を持たせない設計に変更したことで、状態定義と拠出可否の自己矛盾が構造的に発生しなくなった。

**対応方針**:

- 積立は `status` 非保持の単純モデルを維持し、必要な操作可否は各UCで直接定義する。

### 2. 目標型積立の月次目安表示条件が文書内で不一致（解消済み）

**確認結果**:

- `docs/spec/usecases.md` の UC-4.1 事後条件を「目標型かつ期限設定時のみ表示」に更新
- `docs/spec/functions.md` の目標型仕様を「期限設定時のみ算出・表示、期限未設定時は非表示」に更新
- `docs/spec/usecases.md` の UC-4.3 表示項目（期限設定時のみ表示）との整合を確認

**解消理由**:

- 月次目安表示条件を「期限ありの目標型のみ表示」に統一したため、期限未設定時の扱いが文書間で一貫した。

**対応方針**:

- 上記方針を仕様の正として維持する。

### 3. 積立カテゴリ無効化時の警告仕様が UC とエッジケースで未整合（解消済み）

**確認結果（2026-02-14）**:

- `docs/spec/usecases.md` の UC-2.3 に以下を明記
  - 積立定義が紐づくカテゴリは UI 上「積立カテゴリ」として表示する
  - 積立カテゴリ無効化時に積立専用の追加確認・追加警告は表示しない
- `docs/spec/usecases.md` のエッジケース表を「通常カテゴリと同様に扱う（積立専用の追加警告なし）」へ更新
- `docs/spec/functions.md` のカテゴリ仕様にも同方針を追記

**解消理由**:

- 警告要否と UI 表示方針が UC / エッジケース / 機能仕様で一致したため。

**対応方針**:

- 積立定義を持つカテゴリは表示上「積立カテゴリ」として扱う。
- 無効化は通常カテゴリと同一ルールで実行し、積立専用の追加確認は設けない。

### 4. `archived` イベントへの新規紐付け可否が未定義（解消済み）

**確認結果（2026-02-14）**:

- `docs/spec/functions.md` の `Event` から `status` 属性および状態遷移定義を削除
- `docs/spec/functions.md` にイベント削除ルール（紐づくトランザクションが存在しない場合のみ物理削除可）を追加
- `docs/spec/usecases.md` の UC-5.7 を「イベントのアーカイブ」から「イベントの削除」に変更
- UC-5.2 の紐付け仕様は状態依存条件を持たない単純モデルとして整合

**解消理由**:

- イベント状態概念を廃止したことで、`archived` への紐付け可否という分岐自体が消滅した。

**対応方針**:

- イベントは状態を持たない。
- 不要イベントは「紐づくトランザクションが0件の場合のみ」物理削除する。

### 5. 予算 UC における未生成年度の扱いが未定義（解消済み）

**根拠（解消前）**:

- `docs/spec/functions.md:137` で未生成 `FiscalYear` は active 相当と定義
- `docs/spec/functions.md:140` で初回予算設定時に年度レコード生成と定義
- `docs/spec/usecases.md` の UC-3.2/3.3 では、当時「active 年度」であることのみ記載

**問題（解消前）**:

- 予算設定画面で未生成年度を選択可能とするかが UC 側で読めない。

**確認結果（2026-02-15）**:

- `docs/spec/usecases.md` の UC-3.2 事前条件に「未生成年度は active 相当として扱い、初回保存時に年度レコードを生成する」を追記
- `docs/spec/usecases.md` の UC-3.3 事前条件に同内容を追記

**解消理由**:

- `functions.md` の年度生成ポリシー（未生成年度は active 相当、初回予算設定時に生成）と UC-3.2/3.3 の事前条件が一致し、未生成年度の扱いが文書間で一貫したため。

**対応方針**:

- 予算系 UC では、対象年度が未生成の場合も active 相当として操作を許可し、初回保存時に年度レコードを生成する方針を維持する。

## 補足

- 本監査は `2026-02-14` 時点の文書間整合性と文書内整合性を対象とした。
