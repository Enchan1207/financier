# 260214 仕様不整合箇所洗い出し

## 修正すべき不整合（3件）

1. UC-5.5 の事後条件で未来日の考慮漏れ
usecases.md の UC-5.5（テンプレートからの一括登録）の事後条件が「内部残高・予算実績が更新される」と 無条件 になっています。UC-1.1 では「当該日付が過去または当日の場合」と条件を付けているため、整合していません。

2. イベント「削除」のUCが存在しない
エッジケース表に「イベント削除時の取引処理」が定義されていますが、イベント削除のユースケースが存在しません。functions.md にも削除の仕様はありません。

3. requirements.md で予算実績への未来日除外が明記されていない
requirements.md §3.8 では内部残高の未来日除外のみ記載されていますが、functions.md・usecases.md では 予算実績も同様に除外 と明記されています。

## 明記推奨（4件）

4. Budget に id 属性がない
他のエンティティはすべて id を持っていますが、Budget だけ複合キー（fiscalYear × categoryId）になっています。意図的であれば注記が必要です。

5–6. UC-7.5/7.6/7.7 の機能仕様が functions.md に不足
年度間比較、イベント単位の影響分析、支出後の内部残高シミュレーションなど、usecases.md に定義された表示項目に対応する記述が functions.md §10 に網羅されていません。

7. completed 積立への拠出停止メカニズムが未定義
拠出は「通常の支出トランザクション」で行われるため、積立が completed になってもカテゴリへの支出登録自体は可能です。どう制御するかが3文書とも未定義です。

---

## 対応記録

### 1. UC-5.5 の事後条件で未来日の考慮漏れ

**対応内容**: usecases.md UC-5.5 の事後条件を修正し、UC-1.1 と同様に「当該日付が過去または当日の場合」という条件を明記。  

**理由**: テンプレートからの一括登録でも未来日が指定可能であり、システム全体の一貫性のため未来日取引は内部残高・予算実績に即座に反映されないべき。

### 2. イベント「削除」のUCが存在しない

**対応内容**: usecases.md のエッジケース表から「イベント削除時の取引処理」の行を削除。イベント削除機能は実装しない。  

**理由**:  

- UC-5.7 で既にアーカイブ機能が定義されており、実質的に削除と同等の効果を持つ
- Cloudflare D1 の制約上、イベントに紐づく多数のトランザクションの eventId を一括更新する処理は困難
- 他エンティティ（カテゴリ・積立）も論理削除（無効化/アーカイブ）で統一されている
- 財務データとして履歴を保全すべき

### 3. requirements.md で予算実績への未来日除外が明記されていない

**対応内容**: requirements.md §3.4 予算セクションに、予算実績の集計には未来日のトランザクションを含めない旨を追記。  

**理由**:

- functions.md・usecases.md では既に予算実績も未来日除外と明記されている
- 未来日は「まだ発生していない」取引であり、内部残高と同様に予算実績にも反映すべきでない
- 予算は年度単位の管理概念であり、未確定の取引を含めるべきではない
- 3文書間の概念的整合性を保つため

---

## 明記推奨事項への対応

### 4. Budget に id 属性がない

**対応内容**: functions.md §5.2 に、Budget が複合キー (fiscalYear, categoryId) を採用している理由を注記として追加。

**理由**: Budget は「年度×カテゴリ」という概念的な組み合わせを表す関係性であり、独立したエンティティではないため、複合キーが適切。

### 5-6. UC-7.5/7.6/7.7 の機能仕様が functions.md に不足

**対応内容**: functions.md §10 に以下のセクションを追加：

- §10.6 年度間比較（UC-7.5対応）
- §10.7 財政体力の推移（UC-7.6対応）
- §10.8 投資判断支援（UC-7.7対応）

**理由**: usecases.md で定義された表示項目の詳細仕様を functions.md に明記し、実装時の参照を容易にするため。

### 7. completed 積立への拠出停止メカニズムが未定義

**対応内容**: functions.md §6.8 に、completed 状態の積立への拠出制御方針を追記。UI レベルで警告を表示し変更を促すが、技術的には登録可能とする。

**理由**: システムの制約思想「利用者の行動を制限しない」に沿い、強制禁止ではなく警告による誘導とする。拠出は通常の支出トランザクションであるため、データベースレベルでの制約は困難。
