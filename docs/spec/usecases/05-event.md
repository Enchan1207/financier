# 5. イベント系

- 索引: [ユースケース定義書](../usecases.md)
- 関連機能: [機能仕様書](../functions.md)
- 関連要件: [要求仕様書](../requirements.md)

---

## UC-5.1 イベントの作成

**概要**: 新しいイベントを作成する。

**基本フロー**:

1. 利用者がイベント名を入力する
2. （任意）期間を設定する
3. 保存する

**事後条件**:

- イベントが作成される

**例**: 「金沢旅行」「2026年ボーナス配分」

---

## UC-5.2 取引をイベントに紐付け

**概要**: 既存のトランザクションをイベントに紐付ける。

**基本フロー**:

1. 利用者が対象トランザクションを選択する
2. 紐付けるイベントを選択する
3. 保存する

**仕様**:

- 既存トランザクションへの後付け紐付けが可能
- 年度を跨いだ紐付けが可能
- 対象年度が closed のトランザクションは紐付け変更不可

---

## UC-5.3 イベント単位の集計閲覧

**概要**: イベントに紐づくトランザクションの集計を閲覧する。

**基本フロー**:

1. 利用者が対象イベントを選択する
2. 以下が表示される
   - 合計金額
   - カテゴリ別内訳
   - 年度別内訳

---

## UC-5.4 イベントテンプレートの作成

**概要**: 繰り返し利用するイベントのテンプレートを作成する。

**基本フロー**:

1. 利用者がテンプレート名を入力する
2. デフォルトの取引定義（`status=active` かつ積立定義非紐付けカテゴリ + 金額のセット）を登録する
3. 保存する

**例**: 「給与セット」（基本給・交通費・各種控除）

---

## UC-5.5 テンプレートからの一括登録

**概要**: テンプレートを使用してイベントとトランザクションを一括登録する。

**事前条件**:

- テンプレート定義に含まれるカテゴリは、`status=active` かつ積立定義が紐づいていない
- 一括登録される各トランザクションは [UC-1.1](./01-transaction.md#uc-1-1) / [UC-1.2](./01-transaction.md#uc-1-2) の登録条件を満たす（対象年度が closed 状態でないこと、未生成年度は active 相当として扱うこと、使用カテゴリが `status=active` であること）
- 一括保存時の `Transaction.type` は、各取引のカテゴリ（`Category.type`）から自動決定する

**基本フロー**:

1. 利用者がテンプレートを選択する
2. テンプレートに基づくダイアログが表示される
3. 各取引の金額を必要に応じて調整する
4. 日付を指定する
5. 一括保存する

**保存原子性**:

- 一括内に 1 件でも事前条件違反の取引が含まれる場合、当該一括登録は全件失敗とし、イベント・トランザクションともに 1 件も保存しない

**事後条件**:

- イベントが作成される
- テンプレート定義に基づくトランザクションが一括で保存される
- 当該日付が過去または当日の場合、内部残高が更新される
- 当該日付が過去または当日の場合、当該年度の予算実績が更新される

**例外フロー**:

- 5a. テンプレート定義に積立カテゴリが含まれる場合 → 一括保存を拒否し、積立カテゴリはテンプレートで使用不可である旨を表示

---

## UC-5.6 イベントの編集

**概要**: 既存イベントの情報を編集する。

**基本フロー**:

1. 利用者が対象イベントを選択する
2. 名称・期間を編集する
3. 保存する

**制約**:

- closed 年度に属するトランザクションのイベント紐付け変更は不可
- イベント自体（名称・期間）は、紐づくトランザクションの年度状態に関わらず編集可能

---

## UC-5.7 イベントの削除

**概要**: 不要なイベントを削除する。

**事前条件**:

- 対象イベントに紐づくトランザクションが存在しない

**基本フロー**:

1. 利用者が対象イベントの削除操作を実行する
2. システムが確認を求める
3. 利用者が確認する

**事後条件**:

- イベントが削除される

**例外フロー**:

- 1a. 対象イベントに紐づくトランザクションが存在する → 削除不可

---
