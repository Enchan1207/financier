# 4. 積立系

- 索引: [ユースケース定義書](../usecases.md)
- 関連機能: [機能仕様書](../functions.md)
- 関連要件: [要求仕様書](../requirements.md)

---

## UC-4.1 積立定義の作成

**概要**: カテゴリ作成時に、積立定義を同時に作成する。

**実行契機**:

- [UC-2.1](./02-category.md#uc-2-1)（カテゴリの作成）で、支出カテゴリに対して「このカテゴリを積立として作成する」を選択したときに実行される

**基本フロー**:

1. 利用者が積立の型（目標型/自由型）を選択する
2. （目標型の場合）目標金額を入力する
3. （目標型の場合、任意）期限を入力する
4. カテゴリ作成の保存と同時に、積立定義を保存する

**システム動作**:

- 既存カテゴリに対する積立定義の新規追加は提供しない

**事後条件**:

- 積立定義が作成される
- （目標型かつ期限設定時のみ）月次目安額が算出・表示される

---

## UC-4.2 積立への拠出

**概要**: 積立に資金を拠出する。

**事前条件**:

- 登録日付が当日または過去日である（未来日は不可）

**基本フロー**:

1. 利用者が積立定義に紐づく支出カテゴリを指定して、支出トランザクションを登録する（[UC-1.1](./01-transaction.md#uc-1-1) と同じ操作。ただし日付は当日または過去日を指定）

**事後条件**:

- 支出トランザクションが保存される
- 積立残高が増加する
- 内部残高が減少する（通常の支出と同様）

**例外フロー**:

- 1a. 未来日を指定した場合 → 登録を拒否し、当日または過去日を指定するようエラー表示

---

## UC-4.3 積立充足率の確認

**概要**: 積立の進捗状況を確認する。

**基本フロー**:

1. 利用者が積立一覧を表示する
2. 各積立について以下が表示される

**表示項目**:

| 項目             | 目標型          | 自由型 |
| ---------------- | --------------- | ------ |
| 積立残高         | ○               | ○      |
| 目標金額         | ○               | −      |
| 進捗率（%）      | ○               | −      |
| 残額             | ○               | −      |
| 月次目安額       | ○（期限設定時） | −      |
| 月次目安との差分 | ○（期限設定時） | −      |

---

## UC-4.4 積立の取り崩し

**概要**: 積立残高を取り崩す（実際に使用する）。

**入力責務**:

- 利用者入力: 取り崩し額、メモ（任意）
- システム自動設定: 取り崩し日（実行時のサーバ日付）

**基本フロー**:

1. 利用者が対象の積立定義を選択する
2. 取り崩し額を入力する
3. （任意）メモを入力する
4. 実行する

**事後条件**:

- 取り崩し履歴（SavingWithdrawal）が記録される
- 積立残高が減少する
- 新たな支出トランザクションは**記録されない**（実支出は拠出時に計上済み）
- 内部残高は変動しない

---
