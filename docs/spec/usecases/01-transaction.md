# 1. トランザクション系

- 索引: [ユースケース定義書](../usecases.md)
- 関連機能: [機能仕様書](../functions.md)
- 関連要件: [要求仕様書](../requirements.md)

---

## UC-1.1 単一取引の登録

**概要**: 利用者が収入または支出のトランザクションを1件登録する。

**事前条件**:

- 対象年度が closed 状態でない（未生成年度は active 相当として扱う）
- 使用するカテゴリが存在し、`status=active` である
- 選択したカテゴリの種別（`Category.type`）が取引種別（`Transaction.type`）と一致している

**基本フロー**:

1. 利用者が取引種別（収入/支出）を選択する
2. 金額を入力する
3. 日付を入力する（未来日も可能）
4. カテゴリを選択する
5. （任意）イベントを紐付ける
6. 名前を入力する
7. 保存する

**事後条件**:

- トランザクションが保存される
- 当該日付が過去または当日の場合、内部残高が更新される
- 当該日付が過去または当日の場合、当該年度の予算実績が更新される

**代替フロー**:

- 4a. 適切なカテゴリが存在しない場合 → [UC-2.1](./02-category.md#uc-2-1)（カテゴリ作成）を実行後、再開
- 7a. 取引種別とカテゴリ種別が不一致の場合 → 保存を拒否し、種別不一致エラーを表示

---

## UC-1.2 未来日取引の登録

**概要**: 将来の日付で取引を予約登録する。

**事前条件**:

- [UC-1.1](./01-transaction.md#uc-1-1) と同じ

**基本フロー**:

- [UC-1.1](./01-transaction.md#uc-1-1) と同じ（日付に未来日を指定）

**年度解決ルール**:

- `transactionDate` から論理年度（開始年）を解決して帰属する
- 対象の `FiscalYear` が未生成でも登録可能（未生成年度は active 相当として扱う）
- 対象の `FiscalYear` が closed の場合は登録不可

**事後条件**:

- トランザクションが保存される
- 内部残高には**含まれない**（当該日に到達するまで）
- 予算実績の集計には**含まれない**（当該日に到達するまで）
- 取引一覧には表示される（未来日取引として識別可能）

---

## UC-1.3 取引の編集

**概要**: 既存のトランザクションを修正する。

**事前条件**:

- 対象トランザクションが属する年度が closed 状態でない
- 更新後 `transactionDate` で解決される年度が closed 状態でない
- 対象カテゴリが `status=archived` の場合、カテゴリ変更なしの更新のみ許可する
- 更新後のカテゴリを変更する場合、カテゴリ種別（`Category.type`）が対象トランザクションの取引種別（`Transaction.type`）と一致している

**基本フロー**:

1. 利用者が対象トランザクションを選択する
2. 金額・日付・カテゴリ・イベント・名前を編集する（カテゴリを変更する場合は `status=active` のカテゴリのみ選択可能）
3. 保存する

**事後条件**:

- トランザクションが更新される
- 内部残高が再計算される

**例外フロー**:

- 1a. 対象年度が closed → 編集不可。閲覧のみ
- 3a. 更新後 `transactionDate` で解決される年度が closed → 保存を拒否
- 3b. 取引種別とカテゴリ種別が不一致 → 保存を拒否し、種別不一致エラーを表示

---

## UC-1.4 取引の削除

**概要**: 既存のトランザクションを削除する。

**事前条件**:

- 対象トランザクションが属する年度が closed 状態でない

**基本フロー**:

1. 利用者が対象トランザクションを選択する
2. 削除を確認する
3. 削除を実行する

**事後条件**:

- トランザクションが削除される
- 内部残高が再計算される

**例外フロー**:

- 1a. 対象年度が closed → 削除不可

---
