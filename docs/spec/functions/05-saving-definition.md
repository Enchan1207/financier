# 6. 積立定義（SavingDefinition）

- 索引: [機能仕様書](../functions.md)
- 関連要件: [要求仕様書](../requirements.md)
- 関連ユースケース: [ユースケース定義書](../usecases.md)

---

## 6.1 定義

将来の支出に備えて資金を計画的に確保するための仕組み。支出カテゴリと 0..1 : 1 の関係を持つ独立エンティティである。

## 6.2 属性

| 属性名       | 型          | 必須 | 説明                          |
| ------------ | ----------- | ---- | ----------------------------- |
| id           | ID          | ○    | 一意識別子                    |
| categoryId   | ID          | ○    | 紐づく支出カテゴリ（1つのみ） |
| type         | goal / free | ○    | 積立の型                      |
| targetAmount | 正の整数    | △    | 目標額（goal型の場合必須）    |
| deadline     | 日付        | −    | 期限（goal型で任意）          |

## 6.2.1 作成タイミングと変更制約

- 積立定義は、支出カテゴリ作成時に「積立として作成する」を選択した場合にのみ作成できる
- 既存カテゴリに対する積立定義の後付け作成は提供しない
- 積立として作成するかどうかの設定は、カテゴリ作成後に変更できない

## 6.3 積立の型

## 目標型（goal）

- 目標金額と期限（任意）を設定する
- （期限設定時のみ）月次目安額を自動算出して表示する: `月次目安額 = 残額 / 残月数`
- 充足率を表示する
- 期限未設定時は月次目安額を表示しない

## 自由型（free）

- 目標金額なし
- 単純な累積表示のみ

## 6.4 積立残高の算出

積立残高は、紐づくカテゴリへの支出トランザクションのうち `transactionDate <= today` の合計から、取り崩し履歴（SavingWithdrawal）の合計を差し引いて算出する。積立残高は永続保存せず、常に集計で算出する。

```
積立残高 = 当該カテゴリの支出トランザクション合計（transactionDate <= today）− 当該積立定義の SavingWithdrawal 合計
```

## 6.5 積立拠出

- 積立への拠出は、紐づく支出カテゴリへの通常の支出トランザクションとして記録する
- 積立拠出の `transactionDate` は当日または過去日のみ許可する（未来日は業務ルール違反として拒否）
- 拠出は内部残高を減少させる（通常の支出と同様）

## 6.6 積立取り崩し

- 積立残高を減少させる操作
- 取り崩し時に新たな支出トランザクションは記録しない
- 実支出は積立拠出の時点で計上済みとする
- 取り崩しは SavingWithdrawal として履歴に記録する

## 6.7 取り崩し履歴（SavingWithdrawal）

## 定義

積立の取り崩し操作を記録する履歴エンティティ。積立定義に紐づく。

## 属性

| 属性名             | 型       | 必須 | 説明           |
| ------------------ | -------- | ---- | -------------- |
| id                 | ID       | ○    | 一意識別子     |
| savingDefinitionId | ID       | ○    | 紐づく積立定義 |
| amount             | 正の整数 | ○    | 取り崩し額     |
| withdrawalDate     | 日付     | ○    | 取り崩し日     |
| memo               | 文字列   | −    | メモ           |
| createdAt          | 日時     | ○    | 作成日時       |

## 仕様

- 取り崩し操作ごとに1件の SavingWithdrawal が作成される
- `withdrawalDate` は利用者入力ではなく、取り崩し実行時のサーバ日付を自動設定する
- 支出トランザクションは生成しない（内部残高に影響しない）
- 積立残高の算出に使用される

## 6.8 年度との関係

- 積立定義は年度に依存しない
- 年度締めの影響を受けない
- 累計は全期間を通じて継続する

---
