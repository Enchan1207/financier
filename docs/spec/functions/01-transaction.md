# 2. トランザクション（Transaction）

- 索引: [機能仕様書](../functions.md)
- 関連要件: [要求仕様書](../requirements.md)
- 関連ユースケース: [ユースケース定義書](../usecases.md)

---

## 2.1 定義

収入または支出の記録単位。本システムの中核データである。

## 2.2 属性

| 属性名          | 型               | 必須 | 説明                   |
| --------------- | ---------------- | ---- | ---------------------- |
| id              | ID               | ○    | 一意識別子             |
| type            | income / expense | ○    | 取引種別               |
| amount          | 正の整数         | ○    | 金額（日本円）         |
| categoryId      | ID               | ○    | 所属カテゴリ           |
| transactionDate | 日付             | ○    | 発生日（未来日入力可） |
| eventId         | ID               | −    | 紐づくイベント（任意） |
| memo            | 文字列           | −    | メモ                   |
| createdAt       | 日時             | ○    | 作成日時               |

## 2.3 仕様

- `transactionDate` により年度帰属が決定される（4月1日〜翌年3月31日）
- 年度帰属は `transactionDate` から論理年度（開始年）を算出して解決する
- 未来日の入力が可能。未来日取引は内部残高に含めない
- 未来日取引は、当該日に到達した時点で内部残高・予算実績に影響する
- 対象年度の `FiscalYear` が未生成の場合でも登録可能（未生成年度は active 相当）
- 年度が closed の場合、そこに属するトランザクションは編集・削除不可
- 編集時は、更新後 `transactionDate` で解決される年度が closed の場合に保存を拒否する
- 参照カテゴリが `archived` のトランザクションは、カテゴリ変更なしの更新のみ許可する
- `categoryId` が参照する `Category.type` は `Transaction.type` と一致しなければならない（`income -> income`, `expense -> expense`）
- 積立拠出は通常の支出トランザクションとして記録する（積立カテゴリへの支出）

## 2.4 収支タイプ別の違い

| 項目     | 収入（income） | 支出（expense）      |
| -------- | -------------- | -------------------- |
| 金額入力 | 金額を直接入力 | 金額を直接入力       |
| 修正頻度 | 低い           | 登録直後の修正を想定 |
| 前月以前 | −              | 原則修正しない       |

---
