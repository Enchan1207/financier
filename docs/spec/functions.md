# 機能仕様書

**プロジェクト名**: financier（個人財務マネジメントシステム）
**最終更新日**: 2026-02-14

---

## 1. ドメインモデル概要

本システムは以下のエンティティ・概念で構成される。

```
Transaction ──── Category ──── SavingDefinition ──── SavingWithdrawal
    │                │
    │                └──── Budget ──── FiscalYear
    │                    （年度×カテゴリ）
    ├──── Event
    │
    ╰╌╌╌╌ FiscalYear（transactionDate により帰属。直接参照は持たない）

EventTemplate（独立）

内部残高（派生値）
```

---

## 2. トランザクション（Transaction）

### 2.1 定義

収入または支出の記録単位。本システムの中核データである。

### 2.2 属性

| 属性名          | 型                   | 必須 | 説明                                     |
| --------------- | -------------------- | ---- | ---------------------------------------- |
| id              | ID                   | ○    | 一意識別子                               |
| type            | income / expense     | ○    | 取引種別                                 |
| amount          | 正の整数             | ○    | 金額（日本円）                           |
| categoryId      | ID                   | ○    | 所属カテゴリ                             |
| transactionDate | 日付                 | ○    | 発生日（未来日入力可）                   |
| eventId         | ID                   | −    | 紐づくイベント（任意）                   |
| memo            | 文字列               | −    | メモ                                     |
| createdAt       | 日時                 | ○    | 作成日時                                 |

### 2.3 仕様

- `transactionDate` により年度帰属が決定される（4月1日〜翌年3月31日）
- 未来日の入力が可能。未来日取引は内部残高に含めない
- 未来日取引は、当該日に到達した時点で内部残高・予算実績に影響する
- 年度が closed の場合、そこに属するトランザクションは編集・削除不可
- 積立拠出は通常の支出トランザクションとして記録する（積立カテゴリへの支出）

### 2.4 収支タイプ別の違い

| 項目       | 収入（income）          | 支出（expense）                  |
| ---------- | ----------------------- | -------------------------------- |
| 金額入力   | 金額を直接入力          | 金額を直接入力                   |
| 修正頻度   | 低い                    | 登録直後の修正を想定             |
| 前月以前   | −                       | 原則修正しない                   |

---

## 3. カテゴリ（Category）

### 3.1 定義

トランザクションを分類するためのラベル。年度に依存せずシステム全体で共通。

### 3.2 属性

| 属性名   | 型                   | 必須 | 説明                                 |
| -------- | -------------------- | ---- | ------------------------------------ |
| id       | ID                   | ○    | 一意識別子                           |
| name     | 文字列               | ○    | カテゴリ名                           |
| type     | income / expense     | ○    | カテゴリ種別                         |
| isActive | 真偽値               | ○    | 有効/無効（論理削除に使用）          |

### 3.3 仕様

- 階層構造は持たない（フラット）
- ユーザによる追加・編集が可能
- 有効/無効の切り替えが可能（論理削除）
- カテゴリ種別（income / expense）は作成時に決定し、変更不可
- カテゴリ自体にはメタデータを持たせない（積立情報等は積立定義エンティティが保持）

---

## 4. 年度（FiscalYear）

### 4.1 定義

会計の区切りとなる期間。予算管理の境界として機能する。

### 4.2 属性

| 属性名     | 型                   | 必須 | 説明                                   |
| ---------- | -------------------- | ---- | -------------------------------------- |
| id         | ID                   | ○    | 一意識別子                             |
| year       | 整数                 | ○    | 年度（開始年。例: 2026年度 → 2026）    |
| status     | active / closed      | ○    | 年度状態                               |

### 4.3 期間定義

- 4月1日開始〜翌年3月31日終了
- 例: 2026年度 = 2026年4月1日 〜 2027年3月31日

### 4.4 状態遷移

```
active ──→ closed
```

- **active**: 編集可能。トランザクションの追加・編集・削除、予算の設定・変更が可能
- **closed**: 締め済み。当該年度に属するトランザクション・予算は一切変更不可

### 4.5 年度締め時の動作

1. 当該年度のトランザクションをロック（編集・削除不可）
2. 当該年度の予算を固定
3. 次年度を生成（任意で前年度の予算設定をコピー可能）
4. 積立定義は変更なし（年度非依存のため）
5. イベントは変更なし（年度非依存のため）

### 4.6 予算繰越

予算の繰越は行わない。未使用予算は消滅する。

---

## 5. 予算（Budget）

### 5.1 定義

年度×カテゴリ単位で設定される金額の目安。

### 5.2 属性

| 属性名       | 型     | 必須 | 説明                           |
| ------------ | ------ | ---- | ------------------------------ |
| fiscalYear   | 年度   | ○    | 対象年度                       |
| categoryId   | ID     | ○    | 対象カテゴリ                   |
| budgetAmount | 正の整数 | ○  | 予算額（年額ベース）           |

### 5.3 仕様

- 収入カテゴリ・支出カテゴリの双方に予算を設定できる
- 予算は年額ベースで管理する
- 強制制約ではない（超過入力を禁止しない）
- 実績との差分を可視化する

### 5.4 整合条件（警告のみ）

以下の条件を満たさない場合、警告を表示する。ただし操作は制限しない。

```
年度支出予算合計 ≤ 年度収入予算合計
```

### 5.5 予算定義ヘルパ

予算入力時の補助機能として、以下のパターンに対応する。

| パターン   | 説明                                 |
| ---------- | ------------------------------------ |
| 月額固定   | 月額を入力し ×12 で年額を算出        |
| 月ごと変動 | 各月の金額を入力し年額を合算         |

以下には対応しない:

- 実績からの自動算出
- 予算の自動調整

---

## 6. 積立定義（SavingDefinition）

### 6.1 定義

将来の支出に備えて資金を計画的に確保するための仕組み。支出カテゴリと 0..1 : 1 の関係を持つ独立エンティティである。

### 6.2 属性

| 属性名       | 型                              | 必須 | 説明                               |
| ------------ | ------------------------------- | ---- | ---------------------------------- |
| id           | ID                              | ○    | 一意識別子                         |
| categoryId   | ID                              | ○    | 紐づく支出カテゴリ（1つのみ）      |
| type         | goal / free                     | ○    | 積立の型                           |
| targetAmount | 正の整数                        | △    | 目標額（goal型の場合必須）         |
| deadline     | 日付                            | −    | 期限（goal型で任意）               |
| status       | active / completed / archived   | ○    | 状態                               |

### 6.3 積立の型

#### 目標型（goal）

- 目標金額と期限（任意）を設定する
- 月次目安額を自動算出して表示する: `月次目安額 = 残額 / 残月数`
- 充足率を表示する

#### 自由型（free）

- 目標金額なし
- 単純な累積表示のみ

### 6.4 積立残高の算出

積立残高は、紐づくカテゴリへの支出トランザクション合計から、取り崩し履歴（SavingWithdrawal）の合計を差し引いて算出する。積立残高は永続保存せず、常に集計で算出する。

```
積立残高 = 当該カテゴリの支出トランザクション合計 − 当該積立定義の SavingWithdrawal 合計
```

### 6.5 積立拠出

- 積立への拠出は、紐づく支出カテゴリへの通常の支出トランザクションとして記録する
- 拠出は内部残高を減少させる（通常の支出と同様）

### 6.6 積立取り崩し

- 積立残高を減少させる操作
- 取り崩し時に新たな支出トランザクションは記録しない
- 実支出は積立拠出の時点で計上済みとする
- 取り崩しは SavingWithdrawal として履歴に記録する

### 6.7 取り崩し履歴（SavingWithdrawal）

#### 定義

積立の取り崩し操作を記録する履歴エンティティ。積立定義に紐づく。

#### 属性

| 属性名             | 型       | 必須 | 説明                                 |
| ------------------ | -------- | ---- | ------------------------------------ |
| id                 | ID       | ○    | 一意識別子                           |
| savingDefinitionId | ID       | ○    | 紐づく積立定義                       |
| amount             | 正の整数 | ○    | 取り崩し額                           |
| withdrawalDate     | 日付     | ○    | 取り崩し日                           |
| memo               | 文字列   | −    | メモ                                 |
| createdAt          | 日時     | ○    | 作成日時                             |

#### 仕様

- 取り崩し操作ごとに1件の SavingWithdrawal が作成される
- 支出トランザクションは生成しない（内部残高に影響しない）
- 積立残高の算出に使用される

### 6.8 状態遷移

```
active ──→ completed ──→ archived
```

- **active**: 拠出・取り崩しが可能
- **completed**: 完了。拠出は停止。取り崩しのみ可能
- **archived**: アーカイブ済み。閲覧のみ

### 6.9 年度との関係

- 積立定義は年度に依存しない
- 年度締めの影響を受けない
- 累計は全期間を通じて継続する

---

## 7. イベント（Event）

### 7.1 定義

トランザクションを横断的に束ねるグルーピング概念。

### 7.2 属性

| 属性名    | 型           | 必須 | 説明                               |
| --------- | ------------ | ---- | ---------------------------------- |
| id        | ID           | ○    | 一意識別子                         |
| name      | 文字列       | ○    | イベント名                         |
| dateRange | 日付範囲     | −    | 期間（任意）                       |
| status    | active / archived | ○ | 状態                              |

### 7.3 仕様

- 年度を跨いでトランザクションを束ねられる
- 既存トランザクションへの後付け紐付けが可能
- 名称変更が可能
- 前年度（closed）に属するトランザクションは編集不可（ロック済み）

### 7.4 用途例

- 旅行（金沢旅行、海外旅行）
- 家電購入
- 給与一式
- 特定プロジェクトの支出

### 7.5 状態遷移

```
active ──→ archived
```

---

## 8. イベントテンプレート（EventTemplate）

### 8.1 定義

繰り返し発生するイベントのテンプレート。

### 8.2 属性

| 属性名              | 型                     | 必須 | 説明                             |
| -------------------- | ---------------------- | ---- | -------------------------------- |
| id                   | ID                     | ○    | 一意識別子                       |
| name                 | 文字列                 | ○    | テンプレート名                   |
| defaultTransactions  | テンプレート取引の配列 | ○    | デフォルトの取引定義             |

### 8.3 用途例

- 給与セット（基本給・交通費・控除など一括入力）
- 旅行パターン（交通費・宿泊費・食費など）
- ボーナス配分

### 8.4 仕様

- テンプレートからイベントを作成し、トランザクションを一括登録できる
- 一括登録時に金額の調整が可能
- 給与は特別扱いしない（通常のテンプレートとして定義）

---

## 9. 内部残高（派生値）

### 9.1 定義

全期間の収支差分から算出される、利用者の財政体力を示す指標。

### 9.2 算出式

```
内部残高 = 全期間の収入トランザクション合計 − 全期間の支出トランザクション合計
```

- 支出には積立カテゴリへの拠出を含む
- 未来日トランザクションは含めない

### 9.3 特性

- 全期間累積の派生値である
- 年度に依存しない
- 永続保存は不要（トランザクションから都度算出可能。キャッシュは許容）
- 実口座残高との一致は保証しない
- マイナスになりうる（システムはこれを禁止しない）

---

## 10. 表示・分析機能

### 10.1 ダッシュボード

| 表示項目         | 説明                               |
| ---------------- | ---------------------------------- |
| 内部残高         | 全期間の収支差分                   |
| 積立合計         | 全積立定義の残高合計               |
| 年度収支サマリ   | 当年度の収入・支出・差分           |

### 10.2 円グラフ

- 年度単位でカテゴリ構成比を表示
  - 収入カテゴリ構成比
  - 支出カテゴリ構成比
- 円グラフは構成比のみを表す

### 10.3 棒グラフ

- カテゴリ別に実績・予算・差分を表示
- 年度単位・月次フィルタの両方に対応

### 10.4 一覧・サマリ

- 年度収支サマリ
- 積立進捗一覧
- カテゴリ別金額・割合・予算差分
- 年度別内部残高推移

### 10.5 イベント別集計

- イベント単位の合計金額
- カテゴリ内訳
- 年度別内訳

---

## 11. 月次の扱い

月は独立した管理単位ではない。以下の用途でのみ使用する:

- 表示フィルタ（月単位での取引絞り込み）
- レポート集計軸（月別推移の表示）

月次の予算上限管理は行わない。
