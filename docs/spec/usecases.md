# ユースケース定義書

**プロジェクト名**: financier（個人財務マネジメントシステム）
**最終更新日**: 2026-02-15

---

## 1. トランザクション系

### UC-1.1 単一取引の登録

**概要**: 利用者が収入または支出のトランザクションを1件登録する。

**事前条件**:

- 対象年度が closed 状態でない（未生成年度は active 相当として扱う）
- 使用するカテゴリが存在し、`status=active` である
- 選択したカテゴリの種別（`Category.type`）が取引種別（`Transaction.type`）と一致している

**基本フロー**:

1. 利用者が取引種別（収入/支出）を選択する
2. 金額を入力する
3. 日付を入力する（未来日も可能）
4. カテゴリを選択する
5. （任意）イベントを紐付ける
6. （任意）メモを入力する
7. 保存する

**事後条件**:

- トランザクションが保存される
- 当該日付が過去または当日の場合、内部残高が更新される
- 当該日付が過去または当日の場合、当該年度の予算実績が更新される

**代替フロー**:

- 4a. 適切なカテゴリが存在しない場合 → UC-2.1（カテゴリ作成）を実行後、再開
- 7a. 取引種別とカテゴリ種別が不一致の場合 → 保存を拒否し、種別不一致エラーを表示

---

### UC-1.2 未来日取引の登録

**概要**: 将来の日付で取引を予約登録する。

**事前条件**:

- UC-1.1 と同じ

**基本フロー**:

- UC-1.1 と同じ（日付に未来日を指定）

**年度解決ルール**:

- `transactionDate` から論理年度（開始年）を解決して帰属する
- 対象の `FiscalYear` が未生成でも登録可能（未生成年度は active 相当として扱う）
- 対象の `FiscalYear` が closed の場合は登録不可

**事後条件**:

- トランザクションが保存される
- 内部残高には**含まれない**（当該日に到達するまで）
- 予算実績の集計には**含まれない**（当該日に到達するまで）
- 取引一覧には表示される（未来日取引として識別可能）

---

### UC-1.3 取引の編集

**概要**: 既存のトランザクションを修正する。

**事前条件**:

- 対象トランザクションが属する年度が closed 状態でない
- 更新後 `transactionDate` で解決される年度が closed 状態でない
- 対象カテゴリが `status=archived` の場合、カテゴリ変更なしの更新のみ許可する
- 更新後のカテゴリを変更する場合、カテゴリ種別（`Category.type`）が対象トランザクションの取引種別（`Transaction.type`）と一致している

**基本フロー**:

1. 利用者が対象トランザクションを選択する
2. 金額・日付・カテゴリ・イベント・メモを編集する（カテゴリを変更する場合は `status=active` のカテゴリのみ選択可能）
3. 保存する

**事後条件**:

- トランザクションが更新される
- 内部残高が再計算される

**例外フロー**:

- 1a. 対象年度が closed → 編集不可。閲覧のみ
- 3a. 更新後 `transactionDate` で解決される年度が closed → 保存を拒否
- 3b. 取引種別とカテゴリ種別が不一致 → 保存を拒否し、種別不一致エラーを表示

---

### UC-1.4 取引の削除

**概要**: 既存のトランザクションを削除する。

**事前条件**:

- 対象トランザクションが属する年度が closed 状態でない

**基本フロー**:

1. 利用者が対象トランザクションを選択する
2. 削除を確認する
3. 削除を実行する

**事後条件**:

- トランザクションが削除される
- 内部残高が再計算される

**例外フロー**:

- 1a. 対象年度が closed → 削除不可

---

## 2. カテゴリ系

### UC-2.1 カテゴリの作成

**概要**: 新しいカテゴリを作成する。

**基本フロー**:

1. 利用者がカテゴリ種別（収入/支出）を選択する
2. カテゴリ名を入力する
3. （支出カテゴリの場合）「このカテゴリを積立として作成する」を選択できる
4. （3で選択した場合）積立設定を入力する（UC-4.1）
5. 保存する

**事後条件**:

- カテゴリが `status=active` で作成される
- （積立として作成した場合）積立定義が同時に作成される

**補足**:

- 積立として作成するかどうかはカテゴリ作成時にのみ決定でき、作成後は変更できない

---

### UC-2.2 カテゴリの編集

**概要**: 既存カテゴリの名称を変更する。

**基本フロー**:

1. 利用者が対象カテゴリを選択する
2. カテゴリ名を編集する
3. 保存する

**事後条件**:

- カテゴリ名が更新される
- 既存トランザクション・予算への影響なし

---

### UC-2.3 カテゴリのアーカイブ

**概要**: カテゴリの `status` を `archived` に変更し、新規利用を停止する。

**基本フロー**:

1. 利用者が対象カテゴリを選択する
2. アーカイブを実行する

**システム動作**:

- 積立定義が紐づくカテゴリは UI 上「積立カテゴリ」として表示する
- 積立カテゴリをアーカイブする際に、積立専用の追加確認や警告は表示しない
- `status=archived` のカテゴリは新規トランザクション作成・編集時の選択肢に表示しない
- `status=archived` のカテゴリへの新規指定・変更を伴うトランザクション登録・更新は拒否する
- 既存トランザクションが `status=archived` のカテゴリを参照している場合、カテゴリ変更なしの更新は許可する
- カテゴリ削除は物理削除とし、トランザクション・予算・積立定義の参照がすべて 0 件の場合のみ許可する

**事後条件**:

- カテゴリが `status=archived` になる
- 新規トランザクション作成時の選択肢に表示されなくなる
- 既存トランザクション・予算は影響を受けない

---

## 3. 予算系

### UC-3.1 年度予算の作成

**概要**: 新年度の予算を作成する。

**事前条件**:

- 対象年度が active 状態である
- 対象年度が未生成の場合は active 相当として扱い、初回保存時に年度レコードを生成する

**基本フロー**:

1. 利用者が対象年度を指定する
2. カテゴリごとに予算額を設定する
3. 保存する

**代替フロー**:

- 2a. 前年度の予算設定をコピーして、それを基に調整する

**事後条件**:

- 年度×カテゴリ単位の予算が保存される

---

### UC-3.2 カテゴリ予算の設定・変更

**概要**: 特定年度・カテゴリの予算額を設定または変更する。

**事前条件**:

- 対象年度が active 状態である
- 対象年度が未生成の場合は active 相当として扱い、初回保存時に年度レコードを生成する

**基本フロー**:

1. 利用者が年度とカテゴリを選択する
2. 予算額を入力する（直接入力、または予算定義ヘルパを使用）
3. 保存する

**予算定義ヘルパ**:

- 月額固定: 月額 × 12 で年額を算出
- 月ごと変動: 各月の金額を入力し合算

**システム動作**:

- 支出予算合計が収入予算合計を超える場合、警告を表示する
- 操作自体は制限しない

---

### UC-3.3 予算の再配分

**概要**: 既存の予算を複数カテゴリ間で再配分する。

**事前条件**:

- 対象年度が active 状態である
- 対象年度が未生成の場合は active 相当として扱い、初回保存時に年度レコードを生成する

**基本フロー**:

1. 利用者が再配分元のカテゴリと減額幅を指定する
2. 再配分先のカテゴリと増額幅を指定する
3. 差分を確認する
4. 保存する

**システム動作**:

- 再配分前後の差分を表示する
- 強制制約なし、警告のみ

---

### UC-3.4 年度予算実績の確認

**概要**: 年度の予算に対する実績と差分を確認する。

**基本フロー**:

1. 利用者が対象年度を選択する
2. カテゴリ別に予算・実績・差分が表示される

**システム動作**:

- 予算超過も含めてそのまま表示する（制限しない）

---

## 4. 積立系

### UC-4.1 積立定義の作成

**概要**: カテゴリ作成時に、積立定義を同時に作成する。

**実行契機**:

- UC-2.1（カテゴリの作成）で、支出カテゴリに対して「このカテゴリを積立として作成する」を選択したときに実行される

**基本フロー**:

1. 利用者が積立の型（目標型/自由型）を選択する
2. （目標型の場合）目標金額を入力する
3. （目標型の場合、任意）期限を入力する
4. カテゴリ作成の保存と同時に、積立定義を保存する

**システム動作**:

- 既存カテゴリに対する積立定義の新規追加は提供しない

**事後条件**:

- 積立定義が作成される
- （目標型かつ期限設定時のみ）月次目安額が算出・表示される

---

### UC-4.2 積立への拠出

**概要**: 積立に資金を拠出する。

**事前条件**:

- 登録日付が当日または過去日である（未来日は不可）

**基本フロー**:

1. 利用者が積立定義に紐づく支出カテゴリを指定して、支出トランザクションを登録する（UC-1.1 と同じ操作。ただし日付は当日または過去日を指定）

**事後条件**:

- 支出トランザクションが保存される
- 積立残高が増加する
- 内部残高が減少する（通常の支出と同様）

**例外フロー**:

- 1a. 未来日を指定した場合 → 登録を拒否し、当日または過去日を指定するようエラー表示

---

### UC-4.3 積立充足率の確認

**概要**: 積立の進捗状況を確認する。

**基本フロー**:

1. 利用者が積立一覧を表示する
2. 各積立について以下が表示される

**表示項目**:

| 項目             | 目標型          | 自由型 |
| ---------------- | --------------- | ------ |
| 積立残高         | ○               | ○      |
| 目標金額         | ○               | −      |
| 進捗率（%）      | ○               | −      |
| 残額             | ○               | −      |
| 月次目安額       | ○（期限設定時） | −      |
| 月次目安との差分 | ○（期限設定時） | −      |

---

### UC-4.4 積立の取り崩し

**概要**: 積立残高を取り崩す（実際に使用する）。

**入力責務**:

- 利用者入力: 取り崩し額、メモ（任意）
- システム自動設定: 取り崩し日（実行時のサーバ日付）

**基本フロー**:

1. 利用者が対象の積立定義を選択する
2. 取り崩し額を入力する
3. （任意）メモを入力する
4. 実行する

**事後条件**:

- 取り崩し履歴（SavingWithdrawal）が記録される
- 積立残高が減少する
- 新たな支出トランザクションは**記録されない**（実支出は拠出時に計上済み）
- 内部残高は変動しない

---

## 5. イベント系

### UC-5.1 イベントの作成

**概要**: 新しいイベントを作成する。

**基本フロー**:

1. 利用者がイベント名を入力する
2. （任意）期間を設定する
3. 保存する

**事後条件**:

- イベントが作成される

**例**: 「金沢旅行」「2026年ボーナス配分」

---

### UC-5.2 取引をイベントに紐付け

**概要**: 既存のトランザクションをイベントに紐付ける。

**基本フロー**:

1. 利用者が対象トランザクションを選択する
2. 紐付けるイベントを選択する
3. 保存する

**仕様**:

- 既存トランザクションへの後付け紐付けが可能
- 年度を跨いだ紐付けが可能
- 対象年度が closed のトランザクションは紐付け変更不可

---

### UC-5.3 イベント単位の集計閲覧

**概要**: イベントに紐づくトランザクションの集計を閲覧する。

**基本フロー**:

1. 利用者が対象イベントを選択する
2. 以下が表示される
   - 合計金額
   - カテゴリ別内訳
   - 年度別内訳

---

### UC-5.4 イベントテンプレートの作成

**概要**: 繰り返し利用するイベントのテンプレートを作成する。

**基本フロー**:

1. 利用者がテンプレート名を入力する
2. デフォルトの取引定義（`status=active` かつ積立定義非紐付けカテゴリ + 金額のセット）を登録する
3. 保存する

**例**: 「給与セット」（基本給・交通費・各種控除）

---

### UC-5.5 テンプレートからの一括登録

**概要**: テンプレートを使用してイベントとトランザクションを一括登録する。

**事前条件**:

- テンプレート定義に含まれるカテゴリは、`status=active` かつ積立定義が紐づいていない
- 一括登録される各トランザクションは UC-1.1 / UC-1.2 の登録条件を満たす（対象年度が closed 状態でないこと、未生成年度は active 相当として扱うこと、使用カテゴリが `status=active` であること）
- 一括保存時の `Transaction.type` は、各取引のカテゴリ（`Category.type`）から自動決定する

**基本フロー**:

1. 利用者がテンプレートを選択する
2. テンプレートに基づくダイアログが表示される
3. 各取引の金額を必要に応じて調整する
4. 日付を指定する
5. 一括保存する

**保存原子性**:

- 一括内に 1 件でも事前条件違反の取引が含まれる場合、当該一括登録は全件失敗とし、イベント・トランザクションともに 1 件も保存しない

**事後条件**:

- イベントが作成される
- テンプレート定義に基づくトランザクションが一括で保存される
- 当該日付が過去または当日の場合、内部残高が更新される
- 当該日付が過去または当日の場合、当該年度の予算実績が更新される

**例外フロー**:

- 5a. テンプレート定義に積立カテゴリが含まれる場合 → 一括保存を拒否し、積立カテゴリはテンプレートで使用不可である旨を表示

---

### UC-5.6 イベントの編集

**概要**: 既存イベントの情報を編集する。

**基本フロー**:

1. 利用者が対象イベントを選択する
2. 名称・期間を編集する
3. 保存する

**制約**:

- イベントに紐づくトランザクションのうち、closed 年度に属するものは編集不可

---

### UC-5.7 イベントの削除

**概要**: 不要なイベントを削除する。

**事前条件**:

- 対象イベントに紐づくトランザクションが存在しない

**基本フロー**:

1. 利用者が対象イベントの削除操作を実行する
2. システムが確認を求める
3. 利用者が確認する

**事後条件**:

- イベントが削除される

**例外フロー**:

- 1a. 対象イベントに紐づくトランザクションが存在する → 削除不可

---

## 6. 年度締め系

### UC-6.1 年度締めの実行

**概要**: 対象年度を締め、次年度を準備する。

**事前条件**:

- 対象年度が active 状態である

**基本フロー**:

1. 利用者が対象年度の年度締めを実行する
2. システムが確認を求める
3. 利用者が確認する
4. 年度締め処理が実行される

**年度締め処理の詳細**:

1. 当該年度のトランザクションをロック（編集・削除不可に）
2. 当該年度の予算を固定
3. 次年度を active 状態で生成する
4. （利用者の選択に応じて）前年度の予算設定を次年度にコピーする
5. 積立定義は変更なし
6. イベントは変更なし

**事後条件**:

- 対象年度が closed 状態に遷移する
- 次年度が active 状態で存在する

---

## 7. 分析・可視化系

### UC-7.1 ダッシュボードの表示

**概要**: 財務状況の全体像を把握する。

**表示項目**:

- 内部残高（全期間）
- 積立残高合計
- 当年度の収支サマリ

---

### UC-7.2 カテゴリ別年度分析

**概要**: 年度内のカテゴリ別実績を分析する。

**表示項目**:

- カテゴリ別の金額・構成比
- 予算との差分
- 円グラフ（構成比）
- 棒グラフ（実績 vs 予算）

**フィルタ**: 年度単位、月次

---

### UC-7.3 イベント別分析

**概要**: イベント単位で支出を分析する。

**表示項目**:

- イベント別総額
- カテゴリ別内訳
- 年度別内訳

---

### UC-7.4 積立進捗分析

**概要**: 全積立定義の進捗状況を一覧で確認する。

**表示項目**:

- 各積立の残高・進捗率
- 目標型の月次目安との乖離

---

### UC-7.5 年度間比較

**概要**: 複数年度の実績を比較する。

**表示項目**:

- 年度別の収入・支出・差分推移
- カテゴリ別の年度間比較

---

### UC-7.6 財政体力の推移表示

**概要**: 内部残高の時系列推移を確認する。

**表示項目**:

- 年度別内部残高推移
- イベント単位の影響分析

---

### UC-7.7 投資判断の支援

**概要**: 大きな支出の意思決定を支援する。

**シナリオ例**: 「20万円の買い物をしても安全か？」

**システム動作**:

- 現在の内部残高を表示する
- 積立充足率を表示する
- 支出後の内部残高見込みを表示する

---

## 8. シナリオ系ユースケース

### UC-8.1 節約による余剰の再配分

**シナリオ**: あるカテゴリで節約に成功し、余剰予算を他カテゴリに回したい。

**フロー**: UC-3.3（予算の再配分）を使用。

---

### UC-8.2 突発出費への予算再編

**シナリオ**: 予期しない出費が発生し、予算を組み替えたい。

**フロー**:

1. 必要に応じて UC-2.1（カテゴリ作成）
2. UC-3.3（予算の再配分）

---

### UC-8.3 旅行総額の把握

**シナリオ**: 旅行にかかった総額をまとめて確認したい。

**フロー**:

1. UC-5.1（イベント作成: 旅行名）
2. UC-5.2（各取引をイベントに紐付け）
3. UC-5.3（イベント単位で集計閲覧）

---

### UC-8.4 未来の予約支出の処理

**シナリオ**: 将来の日付で確定している支出を先に記録したい。

**フロー**: UC-1.2（未来日取引の登録）

---

### UC-8.5 年度を跨ぐイベント

**シナリオ**: 年度を跨いで発生するイベント（長期旅行など）を管理したい。

**フロー**:

1. UC-5.1（イベント作成）
2. 各年度のトランザクションを同一イベントに紐付け（UC-5.2）
3. UC-5.3 で年度別内訳を含めて集計閲覧

---

### UC-8.6 大きな買い物の判断

**シナリオ**: 高額な購入を検討しており、財政的に問題ないか確認したい。

**フロー**: UC-7.7（投資判断の支援）

---

## 9. 潜在的エッジケースとシステム動作

| エッジケース             | システム動作                                                                     |
| ------------------------ | -------------------------------------------------------------------------------- |
| マイナス内部残高         | 禁止しない。警告を表示する                                                       |
| 積立総額 > 内部残高      | 禁止しない。状況を可視化する                                                     |
| 予算未設定の年度         | 予算なしとして扱い、実績のみ表示する                                             |
| 未来年度への大量取引登録 | 許容する。未生成年度は active 相当として扱い、内部残高には当該日到達まで含めない |
| 積立カテゴリのアーカイブ | 通常カテゴリと同様に扱う（積立専用の追加警告なし）                               |
